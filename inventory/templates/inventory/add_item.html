{% extends "base.html" %}
{% load static %}

{% block title %}Add Item - Kitchentory{% endblock %}
{% block page_title %}Add Item{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-6 lg:px-8 max-w-2xl mx-auto" x-data="addItemForm()">
    <!-- Include camera permission modal -->
    {% include 'inventory/components/camera_permission_modal.html' %}
    
    <!-- Include barcode scanner modal -->
    {% include 'inventory/components/barcode_scanner_modal.html' %}
    
    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <!-- Barcode Scanner -->
        <div class="card">
            <div class="card-body">
                <div class="flex space-x-3">
                    <button type="button" 
                            @click="requestCameraAndScan()"
                            class="flex-1 btn btn-primary">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0118.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Scan Barcode
                    </button>
                    <button type="button" 
                            @click="openManualBarcodeEntry()"
                            class="btn btn-outline">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Enter
                    </button>
                </div>
                
                <!-- Barcode display field -->
                <div x-show="scannedBarcode" class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm font-medium text-green-800">Barcode scanned:</span>
                        <span class="text-sm text-green-700 ml-2" x-text="scannedBarcode"></span>
                        <button type="button" 
                                @click="clearBarcode()"
                                class="ml-auto text-green-600 hover:text-green-800">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Product Details -->
        <div class="card">
            <div class="card-header">
                <h3 class="font-medium">Product Details</h3>
            </div>
            <div class="card-body space-y-4">
                <!-- Product Name with Search -->
                <div>
                    <label for="{{ form.name.id_for_label }}" class="form-label">
                        Product Name <span class="text-danger">*</span>
                    </label>
                    {{ form.name }}
                    <div id="search-results" class="mt-1"></div>
                    <div id="search-spinner" class="htmx-indicator">
                        <span class="text-sm text-gray-500">Searching...</span>
                    </div>
                    {% if form.name.errors %}
                    <p class="form-error">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Brand -->
                <div>
                    <label for="{{ form.brand.id_for_label }}" class="form-label">
                        Brand
                    </label>
                    {{ form.brand }}
                    {% if form.brand.errors %}
                    <p class="form-error">{{ form.brand.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Category -->
                <div>
                    <label for="{{ form.category.id_for_label }}" class="form-label">
                        Category <span class="text-danger">*</span>
                    </label>
                    {{ form.category }}
                    {% if form.category.errors %}
                    <p class="form-error">{{ form.category.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Quantity and Location -->
        <div class="card">
            <div class="card-header">
                <h3 class="font-medium">Quantity & Storage</h3>
            </div>
            <div class="card-body space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <!-- Quantity -->
                    <div>
                        <label for="{{ form.current_quantity.id_for_label }}" class="form-label">
                            Quantity <span class="text-danger">*</span>
                        </label>
                        {{ form.current_quantity }}
                        {% if form.current_quantity.errors %}
                        <p class="form-error">{{ form.current_quantity.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Unit -->
                    <div>
                        <label for="{{ form.unit.id_for_label }}" class="form-label">
                            Unit <span class="text-danger">*</span>
                        </label>
                        {{ form.unit }}
                        {% if form.unit.errors %}
                        <p class="form-error">{{ form.unit.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Storage Location -->
                <div>
                    <label for="{{ form.location.id_for_label }}" class="form-label">
                        Storage Location
                    </label>
                    {{ form.location }}
                    {% if form.location.errors %}
                    <p class="form-error">{{ form.location.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Expiration -->
                <div>
                    <label for="{{ form.days_until_expiration.id_for_label }}" class="form-label">
                        Days Until Expiration
                    </label>
                    <div class="flex gap-2">
                        {{ form.days_until_expiration }}
                        <div class="flex gap-1">
                            <button type="button" 
                                    @click="setExpiration(7)"
                                    class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">
                                1 week
                            </button>
                            <button type="button" 
                                    @click="setExpiration(30)"
                                    class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">
                                1 month
                            </button>
                            <button type="button" 
                                    @click="setExpiration(90)"
                                    class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">
                                3 months
                            </button>
                        </div>
                    </div>
                    {% if form.days_until_expiration.errors %}
                    <p class="form-error">{{ form.days_until_expiration.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="flex gap-3">
            <button type="submit" class="btn btn-primary flex-1">
                Add Item
            </button>
            <a href="{% url 'inventory:list' %}" class="btn btn-outline">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
function addItemForm() {
    return {
        scannedBarcode: '',
        isProcessingBarcode: false,
        
        setExpiration(days) {
            document.getElementById('id_days_until_expiration').value = days;
        },
        
        requestCameraAndScan() {
            // Get modal instances
            const cameraModal = document.querySelector('[x-data*="cameraPermissionModal"]').__x.$data;
            const scannerModal = document.querySelector('[x-data*="barcodeScannerModal"]').__x.$data;
            
            // Open camera permission modal first
            cameraModal.open(
                // On permission granted
                () => {
                    // Open scanner modal
                    scannerModal.open(
                        // On scan success
                        (barcodeData) => this.handleBarcodeScanned(barcodeData),
                        // On manual entry request
                        () => this.openManualBarcodeEntry()
                    );
                },
                // On permission denied/skipped
                () => this.openManualBarcodeEntry()
            );
        },
        
        openManualBarcodeEntry() {
            const manualModal = document.querySelector('[x-data*="manualEntryModal"]').__x.$data;
            manualModal.open();
        },
        
        async handleBarcodeScanned(barcodeData) {
            console.log('Barcode scanned in form:', barcodeData);
            this.scannedBarcode = barcodeData.text;
            this.isProcessingBarcode = true;
            
            try {
                // Look up product by barcode via API
                const response = await fetch(`/api/inventory/products/by_barcode/?barcode=${encodeURIComponent(barcodeData.text)}`, {
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                if (response.ok) {
                    const product = await response.json();
                    this.fillProductFromApi(product);
                    this.showNotification('Product found! Details have been filled in.', 'success');
                } else if (response.status === 404) {
                    // Product not found, but barcode is valid
                    this.showManualProductOption(barcodeData.text);
                } else {
                    throw new Error('Failed to lookup product');
                }
            } catch (error) {
                console.error('Error looking up product:', error);
                this.showNotification('Could not look up product. Please fill in details manually.', 'warning');
            } finally {
                this.isProcessingBarcode = false;
            }
        },
        
        fillProductFromApi(product) {
            // Fill form fields with product data
            const nameField = document.getElementById('id_name');
            const brandField = document.getElementById('id_brand');
            const categoryField = document.getElementById('id_category');
            
            if (nameField && product.name) nameField.value = product.name;
            if (brandField && product.brand) brandField.value = product.brand;
            if (categoryField && product.category) categoryField.value = product.category;
            
            // Trigger change events for form validation
            [nameField, brandField, categoryField].forEach(field => {
                if (field) field.dispatchEvent(new Event('change', { bubbles: true }));
            });
        },
        
        clearBarcode() {
            this.scannedBarcode = '';
        },
        
        showManualProductOption(barcode) {
            // Create and show a special notification with manual add option
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full bg-yellow-100 text-yellow-800 border border-yellow-200';
            
            toast.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <span class="text-sm font-medium">Product not found</span>
                            <p class="text-sm mt-1">Barcode ${barcode} is not in our database.</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <a href="/inventory/add-product/?barcode=${barcode}" class="flex-1 px-3 py-2 bg-yellow-600 text-white text-sm rounded-lg hover:bg-yellow-700 text-center">
                            Add Manually
                        </a>
                        <button onclick="this.closest('.fixed').remove()" class="px-3 py-2 bg-yellow-200 text-yellow-800 text-sm rounded-lg hover:bg-yellow-300">
                            Dismiss
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 10000);
        },
        
        showNotification(message, type = 'info') {
            // Create and show a toast notification
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' :
                          type === 'warning' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>' :
                          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
                    </svg>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 5000);
        },
        
        init() {
            // Listen for barcode scanned events
            window.addEventListener('barcodeScanned', (event) => {
                this.handleBarcodeScanned(event.detail);
            });
            
            // Listen for barcode scan errors
            window.addEventListener('barcodeScanError', (event) => {
                this.showNotification(event.detail.error, 'error');
            });
        }
    }
}
</script>
{% endblock %}