{% extends "base.html" %}
{% load static %}

{% block title %}Add Item - Kitchentory{% endblock %}
{% block page_title %}Add Item{% endblock %}

{% block content %}
<!-- Include camera permission modal -->
{% include 'inventory/components/camera_permission_modal.html' %}

<!-- Include barcode scanner modal -->
{% include 'inventory/components/barcode_scanner_modal.html' %}

<div class="px-4 py-6 sm:px-6 lg:px-8 max-w-2xl mx-auto" x-data="addItemForm()">
    
    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <!-- Barcode Scanner -->
        <div class="card">
            <div class="card-body">
                <div class="flex space-x-3">
                    <button type="button" 
                            @click="requestCameraAndScan()"
                            class="flex-1 btn btn-primary">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0118.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Scan Barcode
                    </button>
                    <button type="button" 
                            @click="openManualBarcodeEntry()"
                            class="btn btn-outline">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Enter
                    </button>
                </div>
                
                <!-- Barcode display field -->
                <div x-show="scannedBarcode" class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm font-medium text-green-800">Barcode scanned:</span>
                        <span class="text-sm text-green-700 ml-2" x-text="scannedBarcode"></span>
                        <button type="button" 
                                @click="clearBarcode()"
                                class="ml-auto text-green-600 hover:text-green-800">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Product Details -->
        <div class="card">
            <div class="card-header">
                <h3 class="font-medium">Product Details</h3>
            </div>
            <div class="card-body space-y-4">
                <!-- Product Name with Search -->
                <div>
                    <label for="{{ form.name.id_for_label }}" class="form-label">
                        Product Name <span class="text-danger">*</span>
                    </label>
                    {{ form.name }}
                    <div id="search-results" class="mt-1"></div>
                    <div id="search-spinner" class="htmx-indicator">
                        <span class="text-sm text-gray-500">Searching...</span>
                    </div>
                    {% if form.name.errors %}
                    <p class="form-error">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Brand -->
                <div>
                    <label for="{{ form.brand.id_for_label }}" class="form-label">
                        Brand
                    </label>
                    {{ form.brand }}
                    {% if form.brand.errors %}
                    <p class="form-error">{{ form.brand.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Category -->
                <div>
                    <label for="{{ form.category.id_for_label }}" class="form-label">
                        Category <span class="text-danger">*</span>
                    </label>
                    {{ form.category }}
                    {% if form.category.errors %}
                    <p class="form-error">{{ form.category.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Quantity and Location -->
        <div class="card">
            <div class="card-header">
                <h3 class="font-medium">Quantity & Storage</h3>
            </div>
            <div class="card-body space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <!-- Quantity -->
                    <div>
                        <label for="{{ form.current_quantity.id_for_label }}" class="form-label">
                            Quantity <span class="text-danger">*</span>
                        </label>
                        {{ form.current_quantity }}
                        {% if form.current_quantity.errors %}
                        <p class="form-error">{{ form.current_quantity.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Unit -->
                    <div>
                        <label for="{{ form.unit.id_for_label }}" class="form-label">
                            Unit <span class="text-danger">*</span>
                        </label>
                        {{ form.unit }}
                        {% if form.unit.errors %}
                        <p class="form-error">{{ form.unit.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Storage Location -->
                <div>
                    <label for="{{ form.location.id_for_label }}" class="form-label">
                        Storage Location
                    </label>
                    {{ form.location }}
                    {% if form.location.errors %}
                    <p class="form-error">{{ form.location.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Expiration -->
                <div>
                    <label for="{{ form.days_until_expiration.id_for_label }}" class="form-label">
                        Days Until Expiration
                    </label>
                    <div class="flex gap-2">
                        {{ form.days_until_expiration }}
                        <div class="flex gap-1">
                            <button type="button" 
                                    @click="setExpiration(7)"
                                    class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">
                                1 week
                            </button>
                            <button type="button" 
                                    @click="setExpiration(30)"
                                    class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">
                                1 month
                            </button>
                            <button type="button" 
                                    @click="setExpiration(90)"
                                    class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">
                                3 months
                            </button>
                        </div>
                    </div>
                    {% if form.days_until_expiration.errors %}
                    <p class="form-error">{{ form.days_until_expiration.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="flex gap-3">
            <button type="submit" class="btn btn-primary flex-1">
                Add Item
            </button>
            <a href="{% url 'inventory:list' %}" class="btn btn-outline">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
function addItemForm() {
    return {
        scannedBarcode: '',
        isProcessingBarcode: false,
        
        setExpiration(days) {
            document.getElementById('id_days_until_expiration').value = days;
        },
        
        async requestCameraAndScan() {
            console.log('Scan barcode button clicked');
            
            // Show options to user: Camera or Manual Entry
            const useCamera = confirm('Choose scanning method:\n\nOK = Use Camera (basic camera view)\nCancel = Enter barcode manually');
            
            if (!useCamera) {
                this.openManualBarcodeEntry();
                return;
            }
            
            try {
                console.log('Starting basic camera view...');
                await this.startBasicCamera();
            } catch (error) {
                console.error('Camera failed:', error);
                alert('Camera is not available. Using manual entry instead.');
                this.openManualBarcodeEntry();
            }
        },
        
        async startBasicCamera() {
            // Check if ZXing library is available
            if (typeof ZXing === 'undefined') {
                throw new Error('ZXing barcode library not loaded');
            }
            
            // Create scanning interface
            const scannerContainer = document.createElement('div');
            scannerContainer.id = 'zxing-scanner-container';
            scannerContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: black;
                z-index: 9999;
                display: flex;
                flex-direction: column;
            `;
            
            // Add header
            const header = document.createElement('div');
            header.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                z-index: 10;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            header.innerHTML = `
                <h2 style="margin: 0; font-size: 1.2rem;">Scanning for barcodes...</h2>
                <button id="close-zxing-scanner" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
            `;
            
            // Add video element
            const video = document.createElement('video');
            video.id = 'zxing-video';
            video.style.cssText = `
                width: 100%;
                height: 100%;
                object-fit: cover;
            `;
            video.autoplay = true;
            video.playsInline = true;
            
            // Add scanning frame overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 300px;
                height: 200px;
                border: 2px solid #00ff00;
                border-radius: 10px;
                pointer-events: none;
            `;
            overlay.innerHTML = `
                <div style="position: absolute; top: -30px; left: 0; right: 0; text-align: center; color: white; font-size: 14px;">
                    Position barcode here
                </div>
            `;
            
            // Add manual entry button
            const footer = document.createElement('div');
            footer.style.cssText = `
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 10;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 1rem;
                text-align: center;
            `;
            footer.innerHTML = `
                <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Automatic scanning enabled. Or:</p>
                <button id="manual-entry-zxing" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Enter Barcode Manually</button>
            `;
            
            scannerContainer.appendChild(header);
            scannerContainer.appendChild(video);
            scannerContainer.appendChild(overlay);
            scannerContainer.appendChild(footer);
            document.body.appendChild(scannerContainer);
            
            // Set up event handlers
            document.getElementById('close-zxing-scanner').onclick = () => {
                this.closeZXingScanner();
            };
            
            document.getElementById('manual-entry-zxing').onclick = () => {
                this.closeZXingScanner();
                this.openManualBarcodeEntry();
            };
            
            // Start camera and scanning
            try {
                console.log('Starting ZXing barcode scanner...');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = stream;
                this.currentStream = stream;
                
                // Initialize ZXing scanner
                const codeReader = new ZXing.BrowserMultiFormatReader();
                
                // Start scanning
                codeReader.decodeFromVideoDevice(undefined, video, (result, err) => {
                    if (result) {
                        console.log('✅ Barcode detected:', result.getText());
                        this.closeZXingScanner();
                        this.handleBarcodeScanned({
                            text: result.getText(),
                            format: result.getBarcodeFormat(),
                            timestamp: new Date().toISOString(),
                            source: 'camera'
                        });
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.warn('Scanning error:', err);
                    }
                });
                
                this.codeReader = codeReader;
                console.log('✅ ZXing scanner started successfully');
                
            } catch (error) {
                console.error('Failed to start ZXing scanner:', error);
                this.closeZXingScanner();
                throw error;
            }
        },
        
        closeZXingScanner() {
            // Stop scanner
            if (this.codeReader) {
                this.codeReader.reset();
                this.codeReader = null;
            }
            
            // Stop camera stream
            if (this.currentStream) {
                this.currentStream.getTracks().forEach(track => track.stop());
                this.currentStream = null;
            }
            
            // Remove the container
            const container = document.getElementById('zxing-scanner-container');
            if (container) {
                container.remove();
            }
        },
        
        closeBasicCamera() {
            // Stop camera stream
            if (this.currentStream) {
                this.currentStream.getTracks().forEach(track => track.stop());
                this.currentStream = null;
            }
            
            // Remove the container
            const container = document.getElementById('basic-camera-container');
            if (container) {
                container.remove();
            }
        },
        
        async startDirectScanning() {
            // Create a temporary scanner container
            const scannerContainer = document.createElement('div');
            scannerContainer.id = 'temp-scanner-container';
            scannerContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: black;
                z-index: 9999;
                display: flex;
                flex-direction: column;
            `;
            
            // Add header with close button
            const header = document.createElement('div');
            header.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                z-index: 10;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            header.innerHTML = `
                <h2 style="margin: 0; font-size: 1.2rem;">Scan Barcode</h2>
                <button id="close-scanner" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
            `;
            
            // Add manual entry button
            const footer = document.createElement('div');
            footer.style.cssText = `
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 10;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 1rem;
                text-align: center;
            `;
            footer.innerHTML = `
                <button id="manual-entry" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Enter Manually</button>
            `;
            
            // Add scanning area
            const scanArea = document.createElement('div');
            scanArea.id = 'scanner-area';
            scanArea.style.cssText = `
                flex: 1;
                position: relative;
            `;
            
            scannerContainer.appendChild(header);
            scannerContainer.appendChild(scanArea);
            scannerContainer.appendChild(footer);
            document.body.appendChild(scannerContainer);
            
            // Set up event handlers
            document.getElementById('close-scanner').onclick = () => {
                this.closeDirectScanner();
            };
            
            document.getElementById('manual-entry').onclick = () => {
                this.closeDirectScanner();
                this.openManualBarcodeEntry();
            };
            
            // Wait for scanner to be ready and start scanning
            try {
                // Wait for scanner instance to be ready
                let attempts = 0;
                while (!window.barcodeScanner || !window.barcodeScanner.startScanning || attempts > 50) {
                    if (attempts > 50) {
                        throw new Error('Scanner failed to initialize after 5 seconds');
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                console.log('Scanner ready, starting scan...');
                
                const result = await window.barcodeScanner.startScanning(
                    'scanner-area',
                    (barcodeData) => {
                        console.log('Barcode scanned:', barcodeData);
                        this.closeDirectScanner();
                        this.handleBarcodeScanned(barcodeData);
                    },
                    (error) => {
                        console.error('Scanning error:', error);
                    }
                );
                
                if (!result.success) {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Failed to start scanner:', error);
                this.closeDirectScanner();
                throw error;
            }
        },
        
        closeDirectScanner() {
            // Stop the scanner
            if (window.barcodeScanner) {
                window.barcodeScanner.stopScanning();
            }
            
            // Remove the container
            const container = document.getElementById('temp-scanner-container');
            if (container) {
                container.remove();
            }
        },
        
        proceedWithModals(cameraModal, scannerModal) {
            // Open camera permission modal first
            cameraModal.open(
                // On permission granted
                () => {
                    // Open scanner modal
                    scannerModal.open(
                        // On scan success
                        (barcodeData) => this.handleBarcodeScanned(barcodeData),
                        // On manual entry request
                        () => this.openManualBarcodeEntry()
                    );
                },
                // On permission denied/skipped
                () => this.openManualBarcodeEntry()
            );
        },
        
        openManualBarcodeEntry() {
            console.log('Opening manual barcode entry');
            const manualModalElement = document.querySelector('[x-data*="manualEntryModal"]');
            if (manualModalElement && manualModalElement.__x) {
                manualModalElement.__x.$data.open();
            } else {
                // Fallback: Simple prompt for barcode
                const barcode = prompt('Enter barcode number (8-13 digits):');
                if (barcode && barcode.length >= 8) {
                    this.handleBarcodeScanned({
                        text: barcode,
                        format: 'manual',
                        timestamp: new Date().toISOString(),
                        source: 'manual'
                    });
                }
            }
        },
        
        async handleBarcodeScanned(barcodeData) {
            console.log('Barcode scanned in form:', barcodeData);
            this.scannedBarcode = barcodeData.text;
            this.isProcessingBarcode = true;
            
            try {
                // Try multiple barcode lookup services for better recognition
                const product = await this.lookupProductMultipleSources(barcodeData.text);
                
                if (product) {
                    // Auto-detect category and location
                    const smartData = this.detectCategoryAndLocation(product);
                    this.fillProductFromApi({...product, ...smartData});
                    this.showNotification(`Product found: ${product.name}! Category and location auto-detected.`, 'success');
                } else {
                    // No product found in any database
                    this.showManualProductOption(barcodeData.text);
                }
            } catch (error) {
                console.error('Error looking up product:', error);
                this.showNotification('Could not look up product. Please fill in details manually.', 'warning');
            } finally {
                this.isProcessingBarcode = false;
            }
        },
        
        async lookupProductMultipleSources(barcode) {
            console.log('Looking up barcode in multiple sources:', barcode);
            
            // Source 1: Our internal API
            try {
                const response = await fetch(`/api/inventory/products/by_barcode/?barcode=${encodeURIComponent(barcode)}`, {
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                if (response.ok) {
                    const product = await response.json();
                    console.log('✅ Found in internal database:', product.name);
                    return product;
                }
            } catch (error) {
                console.log('Internal API failed:', error);
            }
            
            // Source 2: Open Food Facts API
            try {
                console.log('Trying Open Food Facts...');
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1 && data.product) {
                    const product = {
                        name: data.product.product_name || data.product.product_name_en || 'Unknown Product',
                        brand: data.product.brands?.split(',')[0]?.trim() || '',
                        category: data.product.categories?.split(',')[0]?.trim() || '',
                        image_url: data.product.image_url || '',
                        barcode: barcode
                    };
                    console.log('✅ Found in Open Food Facts:', product.name);
                    return product;
                }
            } catch (error) {
                console.log('Open Food Facts failed:', error);
            }
            
            // Source 3: UPC Database
            try {
                console.log('Trying UPC Database...');
                const response = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${barcode}`);
                const data = await response.json();
                
                if (data.code === 'OK' && data.items && data.items.length > 0) {
                    const item = data.items[0];
                    const product = {
                        name: item.title || 'Unknown Product',
                        brand: item.brand || '',
                        category: item.category || '',
                        image_url: item.images?.[0] || '',
                        barcode: barcode
                    };
                    console.log('✅ Found in UPC Database:', product.name);
                    return product;
                }
            } catch (error) {
                console.log('UPC Database failed:', error);
            }
            
            // Source 4: Barcode Lookup API
            try {
                console.log('Trying Barcode Lookup...');
                const response = await fetch(`https://api.barcodelookup.com/v3/products?barcode=${barcode}&formatted=y&key=YOUR_API_KEY`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.products && data.products.length > 0) {
                        const item = data.products[0];
                        const product = {
                            name: item.title || item.product_name || 'Unknown Product',
                            brand: item.brand || item.manufacturer || '',
                            category: item.category || '',
                            image_url: item.images?.[0] || '',
                            barcode: barcode
                        };
                        console.log('✅ Found in Barcode Lookup:', product.name);
                        return product;
                    }
                }
            } catch (error) {
                console.log('Barcode Lookup failed:', error);
            }
            
            console.log('❌ Product not found in any database');
            return null;
        },
        
        detectCategoryAndLocation(product) {
            const name = (product.name || '').toLowerCase();
            const category = (product.category || '').toLowerCase();
            const brand = (product.brand || '').toLowerCase();
            const searchText = `${name} ${category} ${brand}`;
            
            console.log('Auto-detecting category and location for:', searchText);
            
            // Dairy products
            if (searchText.match(/milk|cheese|yogurt|yoghurt|butter|cream|dairy|cottage cheese|sour cream|ice cream/)) {
                return { 
                    category: 'Dairy', 
                    location: 'Fridge',
                    days_until_expiration: 7
                };
            }
            
            // Meat & Poultry
            if (searchText.match(/chicken|beef|pork|turkey|ham|bacon|sausage|ground beef|steak|meat|fish|salmon|tuna/)) {
                return { 
                    category: 'Meat & Poultry', 
                    location: 'Fridge',
                    days_until_expiration: 3
                };
            }
            
            // Fruits & Vegetables
            if (searchText.match(/apple|banana|orange|lettuce|tomato|potato|onion|carrot|broccoli|spinach|fruit|vegetable|produce/)) {
                return { 
                    category: 'Produce', 
                    location: 'Fridge',
                    days_until_expiration: 5
                };
            }
            
            // Frozen items
            if (searchText.match(/frozen|ice cream|freezer|popsicle/)) {
                return { 
                    category: 'Frozen', 
                    location: 'Freezer',
                    days_until_expiration: 90
                };
            }
            
            // Bread & Bakery
            if (searchText.match(/bread|bagel|muffin|croissant|bakery|baked|loaf/)) {
                return { 
                    category: 'Bakery', 
                    location: 'Pantry',
                    days_until_expiration: 5
                };
            }
            
            // Beverages
            if (searchText.match(/juice|soda|water|beer|wine|coffee|tea|beverage|drink/)) {
                return { 
                    category: 'Beverages', 
                    location: 'Pantry',
                    days_until_expiration: 30
                };
            }
            
            // Canned goods
            if (searchText.match(/can|canned|soup|sauce|beans|corn|peas/)) {
                return { 
                    category: 'Pantry', 
                    location: 'Pantry',
                    days_until_expiration: 365
                };
            }
            
            // Condiments & Sauces
            if (searchText.match(/ketchup|mustard|mayo|mayonnaise|sauce|dressing|condiment|vinegar|oil/)) {
                return { 
                    category: 'Condiments', 
                    location: 'Pantry',
                    days_until_expiration: 180
                };
            }
            
            // Snacks
            if (searchText.match(/chips|crackers|cookies|candy|chocolate|snack|nuts|pretzels/)) {
                return { 
                    category: 'Snacks', 
                    location: 'Pantry',
                    days_until_expiration: 60
                };
            }
            
            // Default fallback
            return { 
                category: 'Other', 
                location: 'Pantry',
                days_until_expiration: 30
            };
        },
        
        fillProductFromApi(product) {
            // Fill form fields with product data
            const nameField = document.getElementById('id_name');
            const brandField = document.getElementById('id_brand');
            const categoryField = document.getElementById('id_category');
            const locationField = document.getElementById('id_location');
            const expirationField = document.getElementById('id_days_until_expiration');
            
            if (nameField && product.name) {
                nameField.value = product.name;
                console.log('✅ Auto-filled name:', product.name);
            }
            
            if (brandField && product.brand) {
                brandField.value = product.brand;
                console.log('✅ Auto-filled brand:', product.brand);
            }
            
            if (categoryField && product.category) {
                // Try to select the category option
                for (let option of categoryField.options) {
                    if (option.text.toLowerCase().includes(product.category.toLowerCase()) || 
                        option.value.toLowerCase().includes(product.category.toLowerCase())) {
                        categoryField.value = option.value;
                        console.log('✅ Auto-selected category:', option.text);
                        break;
                    }
                }
            }
            
            if (locationField && product.location) {
                // Try to select the location option
                for (let option of locationField.options) {
                    if (option.text.toLowerCase().includes(product.location.toLowerCase()) || 
                        option.value.toLowerCase().includes(product.location.toLowerCase())) {
                        locationField.value = option.value;
                        console.log('✅ Auto-selected location:', option.text);
                        break;
                    }
                }
            }
            
            if (expirationField && product.days_until_expiration) {
                expirationField.value = product.days_until_expiration;
                console.log('✅ Auto-filled expiration:', product.days_until_expiration, 'days');
            }
            
            // Trigger change events for form validation
            [nameField, brandField, categoryField, locationField, expirationField].forEach(field => {
                if (field) field.dispatchEvent(new Event('change', { bubbles: true }));
            });
            
            // Show what was auto-detected
            if (product.location && product.category) {
                this.showNotification(
                    `Smart detection: ${product.category} → ${product.location} (${product.days_until_expiration} days)`, 
                    'info'
                );
            }
        },
        
        clearBarcode() {
            this.scannedBarcode = '';
        },
        
        showManualProductOption(barcode) {
            // Create and show a special notification with manual add option
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full bg-yellow-100 text-yellow-800 border border-yellow-200';
            
            toast.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <span class="text-sm font-medium">Product not found</span>
                            <p class="text-sm mt-1">Barcode ${barcode} is not in our database.</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <a href="/inventory/add-product/?barcode=${barcode}" class="flex-1 px-3 py-2 bg-yellow-600 text-white text-sm rounded-lg hover:bg-yellow-700 text-center">
                            Add Manually
                        </a>
                        <button onclick="this.closest('.fixed').remove()" class="px-3 py-2 bg-yellow-200 text-yellow-800 text-sm rounded-lg hover:bg-yellow-300">
                            Dismiss
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 10000);
        },
        
        showNotification(message, type = 'info') {
            // Create and show a toast notification
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' :
                          type === 'warning' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>' :
                          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
                    </svg>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 5000);
        },
        
        init() {
            // Listen for barcode scanned events
            window.addEventListener('barcodeScanned', (event) => {
                this.handleBarcodeScanned(event.detail);
            });
            
            // Listen for barcode scan errors
            window.addEventListener('barcodeScanError', (event) => {
                this.showNotification(event.detail.error, 'error');
            });
        }
    }
}
</script>
{% endblock %}